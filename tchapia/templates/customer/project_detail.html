{% extends 'partials/base.html' %} {% block content %}
<section class="py-5 bg-light">
  <div class="container">
    <!-- Header with breadcrumb -->
    <div class="row mb-4">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="{% url 'customer:dashboard' %}" class="text-success"
                >Projects</a
              >
            </li>
            <li class="breadcrumb-item active">{{ project.name }}</li>
          </ol>
        </nav>
        <h1 class="display-5 fw-bold text-success mb-2">
          <i class="fas fa-project-diagram me-3"></i>{{ project.name }}
        </h1>
        <div class="d-flex align-items-center gap-3">
          {% if project.status == 'published' %}
          <span class="badge bg-success fs-6">Publié</span>
          {% elif project.status == 'in_progress' %}
          <span class="badge bg-warning fs-6">En cours</span>
          {% elif project.status == 'completed' %}
          <span class="badge bg-info fs-6">Terminé</span>
          {% elif project.status == 'cancelled' %}
          <span class="badge bg-danger fs-6">Annulé</span>
          {% else %}
          <span class="badge bg-secondary fs-6"
            >{{ project.get_status_display }}</span
          >
          {% endif %} {% if project.priority == 'urgent' %}
          <span class="badge bg-danger fs-6">Urgent</span>
          {% elif project.priority == 'high' %}
          <span class="badge bg-warning fs-6">Priorité Haute</span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex gap-2 flex-wrap">
          <a
            href="{% url 'customer:dashboard' %}"
            class="btn btn-outline-secondary"
          >
            <i class="fas fa-arrow-left me-2"></i>Retour
          </a>
          <a
            href="{% url 'customer:project_edit' project.id %}"
            class="btn btn-outline-success"
          >
            <i class="fas fa-edit me-2"></i>Modifier le Projet
          </a>
          {% if project.status in 'draft,published' %}
          <button
            type="button"
            class="btn btn-sm btn-outline-danger"
            title="Supprimer le projet"
            data-bs-toggle="modal"
            data-bs-target="#deleteModal"
            data-project-id="{{ project.id }}"
            data-project-name="{{ project.name }}"
          >
            Supprimer le projet
          </button>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Project Details -->
      <div class="col-lg-8">
        <!-- Basic Information -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="fas fa-info-circle text-success me-2"></i>Informations
              du Projet
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="fw-bold text-muted small">NOM DU PROJET</label>
                <p class="mb-0">{{ project.name }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="fw-bold text-muted small">DATE DE CRÉATION</label>
                <p class="mb-0">{{ project.created_at|date:"d/m/Y à H:i" }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="fw-bold text-muted small">PRIORITÉ</label>
                <p class="mb-0">{{ project.get_priority_display }}</p>
              </div>
              {% if project.deadline %}
              <div class="col-md-6 mb-3">
                <label class="fw-bold text-muted small">DATE LIMITE</label>
                <p class="mb-0">{{ project.deadline|date:"d/m/Y" }}</p>
              </div>
              {% endif %}
            </div>

            <div class="mt-3">
              <label class="fw-bold text-muted small">DESCRIPTION</label>
              <p class="mb-0">{{ project.description|linebreaks }}</p>
            </div>
          </div>
        </div>

        <!-- Project Images -->
        {% if project.project_images.all %}
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="fas fa-images text-success me-2"></i>Images du Projet
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              {% for image in project.project_images.all %}
                <div class="col-md-3 col-sm-4 col-6">
                  <div class="position-relative">
                    <img src="{{ image.image.url }}"
                         class="img-fluid rounded shadow-sm"
                         style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
                         alt="Image du projet"
                         data-bs-toggle="modal"
                         data-bs-target="#imageModal"
                         data-image-url="{{ image.image.url }}"
                         data-image-desc="{{ image.description|default:'Image du projet' }}">
                    {% if image.description %}
                      <small class="text-muted d-block mt-1">{{ image.description }}</small>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Location Information -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="fas fa-map-marker-alt text-success me-2"></i
              >Localisation
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8 mb-3">
                <label class="fw-bold text-muted small">ADRESSE</label>
                <p class="mb-0">{{ project.location_address }}</p>
              </div>
              <div class="col-md-4 mb-3">
                <label class="fw-bold text-muted small">VILLE</label>
                <p class="mb-0">{{ project.city }}</p>
              </div>
              <div class="col-md-4">
                <label class="fw-bold text-muted small">RÉGION</label>
                <p class="mb-0">{{ project.get_region_display }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Budget Information -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="fas fa-money-bill-wave text-success me-2"></i>Budget
            </h5>
          </div>
          <div class="card-body">
            <div class="text-center p-3">
              <h3 class="text-success mb-0">{{ project.budget_range }}</h3>
            </div>
          </div>
        </div>

        <!-- Offers Section -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="fas fa-handshake text-success me-2"></i>Offres Reçues
              <span class="badge bg-success ms-2">{{ offers_count }}</span>
            </h5>
          </div>
          <div class="card-body">
            {% if offers %}
              {% for offer in offers %}
                <div class="card border mb-3 {% if offer.status == 'pending' %}border-warning{% elif offer.status == 'accepted' %}border-success{% elif offer.status == 'rejected' %}border-danger{% endif %}">
                  <div class="card-body">
                    <div class="row">
                      <!-- Handyman Info -->
                      <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                          {% if offer.handyman.user.profile_picture %}
                            <img src="{{ offer.handyman.user.profile_picture.url }}"
                                 class="rounded-circle me-2"
                                 width="40" height="40"
                                 style="object-fit: cover;">
                          {% else %}
                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                 style="width: 40px; height: 40px;">
                              <i class="fas fa-user"></i>
                            </div>
                          {% endif %}
                          <div>
                            <h6 class="mb-0">{{ offer.handyman.user.first_name }} {{ offer.handyman.user.last_name }}</h6>
                            <small class="text-muted">
                              {% if offer.handyman.verification_status == 'verified' %}
                                <i class="fas fa-check-circle text-success me-1"></i>Vérifié
                              {% else %}
                                <i class="fas fa-clock text-warning me-1"></i>En attente
                              {% endif %}
                            </small>
                          </div>
                        </div>

                        <!-- Handyman Stats -->
                        <div class="small text-muted">
                          <div><i class="fas fa-star text-warning me-1"></i>{{ offer.handyman.average_rating|floatformat:1 }}/5</div>
                          <div><i class="fas fa-calendar me-1"></i>{{ offer.handyman.experience_years }} ans</div>
                        </div>^
                      </div>

                      <!-- Offer Details -->
                      <div class="col-md-6">
                        <div class="mb-2">
                          <strong>Message:</strong>
                          <p class="text-muted mb-1">{{ offer.message|truncatewords:20 }}</p>
                        </div>

                        <div class="row">
                          {% if offer.proposed_budget %}
                            <div class="col-6">
                              <small class="text-muted d-block">Budget proposé</small>
                              <span class="fw-bold text-success">{{ offer.proposed_budget|floatformat:0 }} XAF</span>
                            </div>
                          {% endif %}
                          {% if offer.estimated_duration %}
                            <div class="col-6">
                              <small class="text-muted d-block">Durée estimée</small>
                              <span class="fw-bold">{{ offer.estimated_duration }}</span>
                            </div>
                          {% endif %}
                        </div>
                      </div>

                      <!-- Status & Actions -->
                      <div class="col-md-3">
                        <div class="text-end">
                          <!-- Status Badge -->
                          <div class="mb-2">
                            {% if offer.status == 'pending' %}
                              <span class="badge bg-warning">En attente</span>
                            {% elif offer.status == 'accepted' %}
                              <span class="badge bg-success">Acceptée</span>
                            {% elif offer.status == 'rejected' %}
                              <span class="badge bg-danger">Refusée</span>
                            {% elif offer.status == 'withdrawn' %}
                              <span class="badge bg-secondary">Retirée</span>
                            {% endif %}
                          </div>

                          <!-- Date -->
                          <div class="small text-muted mb-2">
                            Reçue {{ offer.created_at|timesince }}
                          </div>

                          <!-- Actions -->
                          {% if offer.status == 'pending' %}
                            <div class="btn-group-vertical d-grid gap-1">
                              <button class="btn btn-sm btn-success">
                                <i class="fas fa-check me-1"></i>Accepter
                              </button>
                              <button class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-times me-1"></i>Refuser
                              </button>
                              <a href="{% url 'base:handyman_profile' offer.handyman.id %}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-user me-1"></i>Profil
                              </a>
                            </div>
                          {% elif offer.status == 'accepted' %}
                            <div class="d-grid gap-1">
                              <button class="btn btn-sm btn-outline-success">
                                <i class="fas fa-phone me-1"></i>Contacter
                              </button>
                              <a href="{% url 'base:handyman_profile' offer.handyman.id %}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-user me-1"></i>Profil
                              </a>
                            </div>
                          {% else %}
                            <a href="{% url 'base:handyman_profile' offer.handyman.id %}" class="btn btn-sm btn-outline-info">
                              <i class="fas fa-user me-1"></i>Voir Profil
                            </a>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-center py-4">
                <i class="fas fa-handshake fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Aucune offre reçue</h5>
                <p class="text-muted mb-0">Les artisans intéressés par votre projet soumettront leurs offres ici.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <!-- Project Statistics -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">
              <i class="fas fa-chart-line me-2"></i>Statistiques
            </h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-6 mb-3">
                <i class="fas fa-bell fa-2x text-success mb-2"></i>
                <h4 class="mb-0">{{ related_notifications.count }}</h4>
                <small class="text-muted">Notifications envoyées</small>
              </div>
              <div class="col-6 mb-3">
                <i class="fas fa-calendar fa-2x text-info mb-2"></i>
                <h4 class="mb-0">{{ project.created_at|timesince }}</h4>
                <small class="text-muted">Publié il y a</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="fas fa-bolt text-success me-2"></i>Actions Rapides
            </h5>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <a
                href="{% url 'customer:project_edit' project.id %}"
                class="btn btn-success"
              >
                <i class="fas fa-edit me-2"></i>Modifier le Projet
              </a>
              <a
                href="{% url 'base:handymen_list' %}?service={{ project.service }}&region={{ project.region }}"
                class="btn btn-outline-success"
              >
                <i class="fas fa-users me-2"></i>Voir les Artisans
              </a>
              <button class="btn btn-outline-warning" onclick="shareProject()">
                <i class="fas fa-share me-2"></i>Partager le Projet
              </button>
            </div>
          </div>
        </div>

        <!-- Project Status -->
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="fas fa-tasks text-success me-2"></i>Statut du Projet
            </h5>
          </div>
          <div class="card-body">
            {% if project.status == 'published' %}
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Projet Publié</strong><br />
              Votre projet est visible par les artisans de votre région.
            </div>
            {% elif project.status == 'draft' %}
            <div class="alert alert-warning">
              <i class="fas fa-edit me-2"></i>
              <strong>Brouillon</strong><br />
              Ce projet n'est pas encore publié.
            </div>
            {% elif project.status == 'in_progress' %}
            <div class="alert alert-info">
              <i class="fas fa-spinner me-2"></i>
              <strong>En Cours</strong><br />
              Un artisan travaille sur ce projet.
            </div>
            {% elif project.status == 'completed' %}
            <div class="alert alert-primary">
              <i class="fas fa-check-double me-2"></i>
              <strong>Terminé</strong><br />
              Ce projet a été complété avec succès.
            </div>
            {% endif %} {% if project.deadline %}
            <div class="mt-3">
              <small class="text-muted">Date limite:</small>
              <p class="mb-0 fw-bold">{{ project.deadline|date:"l d F Y" }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function shareProject() {
    if (navigator.share) {
      navigator.share({
        title: "{{ project.name }}",
        text: "Découvrez ce projet sur Tchapia",
        url: window.location.href,
      });
    } else {
      // Fallback: copy to clipboard
      navigator.clipboard.writeText(window.location.href).then(function () {
        alert("Lien du projet copié dans le presse-papiers!");
      });
    }
  }
</script>
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirmer la suppression
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-warning me-2"></i>
                    <strong>Attention !</strong> Cette action est irréversible.
                </div>
                <p>Êtes-vous sûr de vouloir supprimer le projet <strong id="projectNameToDelete"></strong> ?</p>
                <p class="text-muted small">Toutes les données associées à ce projet seront définitivement perdues.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Annuler
                </button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Supprimer définitivement
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Handle delete modal
document.addEventListener('DOMContentLoaded', function() {
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const projectId = button.getAttribute('data-project-id');
            const projectName = button.getAttribute('data-project-name');

            // Update modal content
            document.getElementById('projectNameToDelete').textContent = projectName;

            // Update form action
            const deleteForm = document.getElementById('deleteForm');
            deleteForm.action = "{% url 'customer:project_delete' 0 %}".replace('0', projectId);
        });
    }
});

// Handle image modal
const imageModal = document.getElementById('imageModal');
if (imageModal) {
    imageModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const imageUrl = button.getAttribute('data-image-url');
        const imageDesc = button.getAttribute('data-image-desc');

        const modalImage = imageModal.querySelector('#modalImage');
        const modalDesc = imageModal.querySelector('#modalImageDesc');

        modalImage.src = imageUrl;
        modalDesc.textContent = imageDesc;
    });
}
</script>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">
                    <i class="fas fa-images text-success me-2"></i>Image du Projet
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid rounded" alt="Image du projet" style="max-height: 70vh;">
                <p id="modalImageDesc" class="text-muted mt-3"></p>
            </div>
        </div>
    </div>
</div>

{% endblock content %}
